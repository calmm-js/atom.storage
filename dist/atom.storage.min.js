!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("infestines")):"function"==typeof define&&define.amd?define(["exports","infestines"],t):t((e.atom=e.atom||{},e.atom.storage={}),e.I)}(this,function(e,m){"use strict";var n=new WeakMap,l=function(e){var t=n.get(e);return t||n.set(e,t={}),t},v=function(e){try{return JSON.parse(e)}catch(e){return e}},d=function(e){return!(e instanceof Error)&&e&&"value"in e},s=function(e){var t=e.key;delete l(e.storage)[t]};e.unsafeDeleteAtom=s,e.expireNow=function(e){for(var t=e.storage,n=e.regex,r=e.unsafeDeleteAtoms,a=0;a<t.length;++a){var o=t.key(a);if(n.test(o)){var i=v(t.getItem(o));d(i)&&i.expires<=Date.now()&&(t.removeItem(o),r&&s({storage:t,key:o}))}}},e.default=function(e){var n=e.key,r=e.storage,a=e.value,t=e.Atom,o=e.time,i=e.schema,s=e.debounce,u=l(r),c=u[n];if(!c){u[n]=c=t(function(e,t,n,r,a){var o=e.getItem(t);if(!o)return r;var i=v(o);return d(i)&&m.acyclicEqualsU(i.schema,n)&&!m.acyclicEqualsU(i.value,r)?(0<=a&&(i.expires=a+Date.now(),e.setItem(t,JSON.stringify(i))),i.value):(e.removeItem(t),r)}(r,n,i,a,o));var f=c.changes();0<=s&&(f=f.debounce(s)),f.onValue(function(e){if(m.acyclicEqualsU(e,a))r.removeItem(n);else{var t={value:e};void 0!==i&&(t.schema=i),0<=o&&(t.expires=o+Date.now()),r.setItem(n,JSON.stringify(t))}})}return c},Object.defineProperty(e,"__esModule",{value:!0})});
